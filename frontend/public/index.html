<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GlobeChat MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

  <!-- Auth Container -->
  <div id="auth-container" class="bg-gray-800 p-8 rounded-xl shadow-xl w-full max-w-md space-y-6">
    <h2 id="auth-title" class="text-3xl font-bold text-center">Login</h2>
    <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-2 bg-gray-700 rounded">
    <input id="password-input" type="password" placeholder="Password" class="w-full px-4 py-2 bg-gray-700 rounded">
    <button id="auth-button" class="w-full py-2 bg-purple-600 rounded hover:bg-purple-700">Login</button>
    <p class="text-center text-sm text-gray-400">
      Donâ€™t have an account?
      <a href="#" id="auth-toggle" class="text-purple-400">Sign Up</a>
    </p>
  </div>

  <!-- Chat App -->
  <div id="app-container" class="hidden w-full max-w-5xl h-[85vh] bg-gray-800 rounded-2xl flex overflow-hidden">

    <!-- Sidebar -->
    <div class="w-1/4 bg-gray-700 p-4 flex flex-col space-y-4">
      <div class="text-xl font-bold">My Chats</div>

      <!-- Search -->
      <input id="user-search-input" type="email" placeholder="Search by email"
             class="px-3 py-2 bg-gray-600 rounded-lg">
      <button id="user-search-button" class="bg-purple-600 py-2 rounded hover:bg-purple-700">Search</button>
      <div id="search-results" class="text-sm text-gray-300"></div>

      <!-- Chat List -->
      <div id="chat-list" class="flex-1 overflow-y-auto mt-4 space-y-1"></div>

      <!-- Language Selector -->
      <div class="pt-4 border-t border-gray-600">
        <label for="language-select" class="block text-sm text-gray-400 mb-1">
          Translate messages to:
        </label>
        <select id="language-select"
          class="w-full bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
          <option value="en">English</option>
          <option value="hi">Hindi</option>
          <option value="fr">French</option>
          <option value="es">Spanish</option>
          <option value="ja">Japanese</option>
          <option value="mr">Marathi</option>
          <option value="te">Telugu</option>
          <option value="ta">Tamil</option>
          <option value="kn">Kannada</option>
          <option value="gu">Gujarati</option>
          <options value="ml">Malayalam</option>
          <option value="bn">Bengali</option>
          <option value="pa">Punjabi</option>
          <option value="or">Odia</option>
          <option value="as">Assamese</option>
          <option value="ne">Nepali</option>
          <option value="si">Sinhala</option>
          <option value="ur">Urdu</option>
        </select>
      </div>

      <!-- User Info -->
      <div class="pt-4 border-t border-gray-600">
        <div id="user-display" class="text-purple-400 font-medium"></div>
        <button id="logout-button" class="text-red-400 mt-2 text-sm">Logout</button>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 flex flex-col">
      <div id="chat-header" class="p-4 bg-gray-700 text-lg font-bold border-b border-purple-500">
        Select a chat
      </div>

      <!-- MESSAGES: enable left/right alignment -->
      <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 flex flex-col"></div>

      <div class="p-4 bg-gray-700 flex">
        <input id="message-input" placeholder="Type message..."
               class="flex-1 px-3 py-2 bg-gray-600 rounded-lg">
        <button id="send-button" class="ml-2 bg-purple-600 px-4 py-2 rounded">Send</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      signInWithEmailAndPassword, createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, getDocs,
      collection, query, where, addDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your Firebase config (kept exactly as you posted)
    const firebaseConfig = {
      apiKey: "AIzaSyDewp9rN2OPl3_hdb8pcBt4xguKsXYtNY8",
      authDomain: "globechat-2025.firebaseapp.com",
      projectId: "globechat-2025",
      storageBucket: "globechat-2025.firebasestorage.app",
      messagingSenderId: "197402288279",
      appId: "1:197402288279:web:3982bfa587fb7679ee89d2",
      measurementId: "G-ZWH3E7SE5T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const socket = io("http://localhost:3001");

    let currentUser = null;
    let selectedChatId = null;
    let preferredLanguage = "en";

    // UI refs
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const authButton = document.getElementById('auth-button');
    const authToggle = document.getElementById('auth-toggle');
    const logoutButton = document.getElementById('logout-button');
    const userDisplay = document.getElementById('user-display');
    const chatHeader = document.getElementById('chat-header');
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const searchInput = document.getElementById('user-search-input');
    const searchButton = document.getElementById('user-search-button');
    const searchResults = document.getElementById('search-results');
    const chatList = document.getElementById('chat-list');
    const languageSelect = document.getElementById('language-select');

    // Login / Signup toggle
    let isSignup = false;
    authToggle.addEventListener('click', () => {
      isSignup = !isSignup;
      authButton.textContent = isSignup ? 'Sign Up' : 'Login';
      authToggle.textContent = isSignup ? 'Login' : 'Sign Up';
    });

    // Login / Signup action
    authButton.addEventListener('click', async () => {
      const email = emailInput.value.trim().toLowerCase();
      const pass = passwordInput.value.trim();
      if (!email || !pass) return;

      if (isSignup) {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
        const user = userCred.user;
        await setDoc(doc(db, "users", user.uid), {
          email: user.email.toLowerCase(),
          preferredLanguage: "en"
        });
      } else {
        await signInWithEmailAndPassword(auth, email, pass);
      }
    });

    // Logout
    logoutButton.addEventListener('click', () => signOut(auth));

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        userDisplay.textContent = user.email;

        // load preferred language (and set if missing)
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          preferredLanguage = userDoc.data().preferredLanguage || "en";
          languageSelect.value = preferredLanguage;
        } else {
          preferredLanguage = "en";
          await setDoc(doc(db, "users", user.uid), {
            email: user.email.toLowerCase(),
            preferredLanguage
          });
        }

        loadUserChats();
      } else {
        currentUser = null;
        authContainer.classList.remove('hidden');
        appContainer.classList.add('hidden');
        messagesContainer.innerHTML = "";
        chatList.innerHTML = "";
      }
    });

    // Sidebar: load chats
    function loadUserChats() {
      const chatQueryRef = query(collection(db, "chats"), where("members", "array-contains", currentUser.uid));
      onSnapshot(chatQueryRef, async (snapshot) => {
        chatList.innerHTML = "";
        for (const docSnap of snapshot.docs) {
          const chat = docSnap.data();
          const otherUserId = chat.members.find(uid => uid !== currentUser.uid);
          const otherUserDoc = await getDoc(doc(db, "users", otherUserId));
          const otherEmail = otherUserDoc.exists() ? otherUserDoc.data().email : "Unknown";

          const chatBtn = document.createElement("button");
          chatBtn.className = "w-full text-left bg-gray-700 hover:bg-gray-600 p-2 rounded-lg";
          chatBtn.textContent = otherEmail;
          chatBtn.onclick = () => openChat(docSnap.id, otherEmail);
          chatList.appendChild(chatBtn);
        }
      });
    }

    // Open chat
    function openChat(chatId, otherEmail) {
      selectedChatId = chatId;
      chatHeader.textContent = otherEmail;
      messagesContainer.innerHTML = "";

      socket.emit("joinChat", {
        chatId: selectedChatId,
        preferredLanguage,
        senderName: currentUser.email
      });
    }

    // Change language
    languageSelect.addEventListener("change", async (e) => {
      preferredLanguage = e.target.value;
      if (currentUser) {
        await setDoc(doc(db, "users", currentUser.uid), { preferredLanguage }, { merge: true });
      }
      if (selectedChatId) {
        socket.emit("joinChat", {
          chatId: selectedChatId,
          preferredLanguage,
          senderName: currentUser.email
        });
      }
    });

    // Search user to start chat
    searchButton.addEventListener("click", async () => {
      const email = searchInput.value.trim().toLowerCase();
      searchResults.innerHTML = "";
      if (!email) return;

      const qRef = query(collection(db, "users"), where("email", "==", email));
      const snap = await getDocs(qRef);
      if (snap.empty) {
        searchResults.textContent = "User not found.";
        return;
      }

      snap.forEach(async (docSnap) => {
        const u = docSnap.data();
        const otherUserId = docSnap.id;

        if (u.email === currentUser.email.toLowerCase()) {
          searchResults.textContent = "That's you.";
          return;
        }

        const btn = document.createElement("button");
        btn.className = "bg-gray-700 px-3 py-2 rounded-lg w-full mt-1";
        btn.textContent = `Chat with ${u.email}`;
        btn.onclick = async () => {
          const pairKey = [currentUser.uid, otherUserId].sort().join("_");
          const existingQ = query(collection(db, "chats"), where("pairKey", "==", pairKey));
          const existingSnap = await getDocs(existingQ);

          let chatId;
          if (!existingSnap.empty) {
            chatId = existingSnap.docs[0].id;
          } else {
            const newChat = await addDoc(collection(db, "chats"), {
              members: [currentUser.uid, otherUserId],
              pairKey,
              updatedAt: new Date()
            });
            chatId = newChat.id;
          }

          openChat(chatId, u.email);
          searchResults.innerHTML = "";
        };
        searchResults.appendChild(btn);
      });
    });

    // Send message
    sendButton.addEventListener("click", () => {
      const text = messageInput.value.trim();
      if (!text || !selectedChatId) return;
      socket.emit("sendMessage", {
        text,
        chatId: selectedChatId,
        senderName: currentUser.email
      });
      messageInput.value = "";
    });

    // --- MESSAGE RENDERING (WhatsApp-style alignment) ---
    function renderMessage(msg) {
      const isSent = currentUser && msg.sender === currentUser.email;
      const bubble = document.createElement("div");

      bubble.className = [
        "max-w-[70%]", "px-3", "py-2", "rounded-lg",
        isSent ? "self-end bg-purple-600 rounded-br-sm" : "self-start bg-gray-700 rounded-bl-sm"
      ].join(" ");

      bubble.innerHTML = `
        <div class="font-medium">${msg.translatedText}</div>
        <div class="text-gray-300 text-xs italic mt-1">Original: ${msg.originalText}</div>
      `;

      messagesContainer.appendChild(bubble);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Socket events
    socket.on("receiveMessage", (msg) => {
      renderMessage(msg);
    });

    socket.on("chatHistory", (history) => {
      messagesContainer.innerHTML = "";
      history.forEach((msg) => renderMessage(msg));
    });
  </script>
</body>
</html>

